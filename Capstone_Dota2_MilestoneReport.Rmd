---
title: "Capstone_Dota2_Milestone"
author: "Arun Bharadwaj"
date: "August 13, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyr)
library(dplyr)
library(ggplot2)
library(reshape2)

```

## Dota2 Capstone Milestone Report

# Introduction

The Dota 2 dataset was downloaded from Kaggle. It is being used for the Springboard Foundations of Data Science course capstone project. The dataset has 18 csv files, with the data of 50,000 ranked Dota matches. 

# Approaching the Capstone

The capstone project is approached by first identifying the problem statement. Next, the most important csv`s files are identified. Data wrangling is done on the most important files followed by other files. After this, exploratory data analysis and some basic statistical correlations are performed. Finally, regressions and machine learning algorithms are used on the dataset.

# Problem Statement

The goal of the capstone is to identify potential biases in the gameplay structure of Dota 2. By gameplay structure, we refer to the more than 100 heroes and items that can be picked by players. It is important that any game, board game or computer game, measures the true skill level of a player accurately. It is possible that some specific combinations of pre-game choices affects the winning ability of a player. If such a situation were to arise, the game is unlikely to be an accurate estimate of the player`s true skill level. 

# Why and for whom is this problem statement important

Valve Corporation is the developer of Dota 2. For Valve Corporation, it is of utmost importance that their games are accurate predictors of player skill level. If a player manages to find loopholes or shortcuts that allow them to win, this will have a negative effect on their reputation. Ensuring fairness and accuracy of gameplay and game mechanic is very important for any game developer.

# What specific questions must be answered, with respect to the dataset, to solve this problem statement

To solve this problem statement, we focus on heroes, combination of heroes in a team and inventory items.

At the start of a game, each player is allowed to choose a hero. Heroes are divided into three types: strength, agility and intelligence. As the names suggest, each type of hero has certain advantages. We can try finding if certain types of heroes allow players to win more easily.

Many Dota games are 5 on 5 multiplayer matches. There are two teams: radiant and dire. Players are allowed to choose any hero from the list of 113 heroes. A hero already chosen by another player cannot be chosen again. So, all ten heroes in a 5 on 5 multiplayer game are unique. For a team, there are no restrictions on the types of heroes they can choose, other than the requirement that all heroes in the game must be unique. A team is free to choose five strength or five agility or five intelligence heroes. 

Finally, each player can buy inventory items using the gold they get from killing creeps, destroying buildings and killing opponent heroes. The player and their hero can use this gold to buy items that improve the attack and defense ratings of the hero. Understanding if specific combinations of heroes and items give a player undue advantage can also help solve the problem statement.

# Important CSV files

match_csv, player_rating_csv and players_csv are the 3 most important csv files. 

match_csv contains high level information about each match including duration, time to first blood, status of tower and barracks of two teams at end of game, geographical region where the game is taking place and the team that won the game (radiant or dire).
```{r 1}
match_csv <- read.csv("Data/match.csv")
head(match_csv)
```
player_ratings_csv has information about all the human players who played the 50,000 games. The information includes player account_id, total games they have played, total games in which they were a part of the winning team, mean of player skill and standard deviation of player skill. Player skill level and their standard deviation have been calculated using Microsoft Research`s trueskill algorithm, which is widely used in the gaming world. Valve Corporation is not involved in the way player skill is calculated. So, the player skill mean and standard deviation columns have to be cross checked for accuracy.
```{r 2,echo=FALSE}
player_ratings_csv <- read.csv("Data/player_ratings.csv")
head(player_ratings_csv)
```
players_csv has specific information about each match, player account_id that participated in the match, hero_id of the hero used by the player, gold earned and spent, xp earned, deaths, kills, assists, stuns and last hits per hero. It also gives detailed information about gold extracted from killing creeps, killing other heroes and destroying buildings.  
```{r 3,echo=FALSE}
players_csv <- read.csv("Data/players.csv")
head(players_csv)
```

# Data Wrangling

## Identify most important csv files
First part of data wrangling is to identify the most important csv files out of the 18 csv files. The 3 most important files have already been identified as match_csv, player_ratings_csv and players_csv. 

## Eliminate columns that do not add value to analysis
Some hist functions were run on game_mode, negative_votes and positive_votes columns of match_csv file. Results from these hist functions showed that two of these variables had only one respective value. While game_mode had two values, the column is still considered insignificant to our analysis due to the nature of game_mode.  Since the three columns do not add value to our analysis, they are removed.

## Check if data points of some important variables make sense 
In match_csv, the mean of first__blood_time returned a value of 93. Having played Dota, it is obvious that 93 minutes is too long for the mean of first blood time. A cursory internet search shows that in a sample tournament, first blood time was 3 minutes. It is safe to assume that the unit of first_blood_time is seconds. Close to 25000 observations have a first blood time less than 100 seconds. This seems improbable since on average, a player takes atleast 1.5 minutes to buy some inventory and head to center of the map.

## Convert incorrect negative values to 0
In multiple columns, there are negative value observations. For instance, some time and account id columns have negative values. This is incorrect and must be modified. Such incorrect negative values are made equal to 0.

### Why not convert incorrect negative values to NA
Majority of incorrect negative values are seen in time columns of different csv files and the account_id column of player_ratings_csv file. In the chat_csv file`s time column, which is arranged in ascending of time per match id, the negative values are very low single digit numbers. It is likely that  these actions occurred at the very beginning of the game. Instead of counting them as 0 time, the data was incorrectly recorded as low negative values. So, for the sake of simplicity, all negative time values are converted to 0. For account_id, we know that players can choose to not reveal their id and are counted as anonymous. These anonymous players are  counted as 0 in the account_id column. Again, for the sake of simplicity, negative account_id are also considered anonymous and converted to 0 value. 

## Nullify columns with very high percentage of NA values
For the sake of simplicity, columns with very high percentage of NA values are nullified. These columns are considered to be not significant for the purpose of our analysis. This is done using the summarise_at() function of dplyr.

# Feature Engineering

## Check if some small csv files can be combined with larger csv files to make it easier to visualize data
In match_csv, a variable called cluster is shown in numeric. This variable shows the geographical region where the match is taking place. A cluster_csv file uses a key value pair, where key is numeric cluster variable and value is name of geographical region. Left_join is used to merge the match_csv and cluster_csv files to help with data visualization. Multiple such operations are performed to combine small csv`s with larger ones.

## Classify hero_id column in players_csv to STR, AGI and INT 
For the ease of classification, analysis and predictive modelling, heroes are classified into STR, AGI and INT. The 113 heroes have already been classified by a former Springboard student, Louis Montague, who has posted this specific csv file on his github profile.

## Remove rows in players_csv and players_ratings_csv where account_id = 0
account_id = 0 are rows where the player has chosen to remain anonymous and not disclose their identity. With account_id being a categorical variable, having too many rows with 0 id`s tends to distort our analysis, especially when combining csv files using account_id. So, while players_csv file is kept as it is, a new players_csv1 is created after removing rows with account_id as 0.

## Replace 0 to 4 and 128-132 in players_csv1 to Radiant and Dire
A cursory internet search shows that the player_slot column in players_csv1 actually stands for the two dota teams: radiant and dire. While 0-4 is team radiant, 128-132 is team dire. These numbers are replaced with team names in the player_slot column of players_csv1.

## Convert observations in columns named item_0 to item_5, in players_csv3, from numbers to class of items to reduce number of factors and enable building of a simple model
item_0 to item_5 columns contain the ID`s of the items bought by players and their respective hero. Heroes have six slots on their dashboard to keep items. The 0 to 5 stands for the six slots. While the original dataset populates item_0 to item_5 columns using the item ID, this project will substantially broaden this classification and convert item_id to item_class. The items will be converted to STR (strength), AGI (agility), INT (intelligence), MOB (mobility), MISC (miscellaneous) etc. Also, some items combine multiple classes. These items are simply classified as 2 class, 3 class upto 5 class. This type of classification reduces number of factors to manageable limits.

item_class_1 is a newly created csv file, which duplicates item_ids_csv and adds a item_class column. The item_class column is populated with the class of items mentioned earlier. This is done using information extracted from the internet.

item_class_1 is combined with players_csv2 using left join operation.

## player_ratings_csv2 created which only includes account_id`s that have played 5 games or more
Human players that have played less than 5 games of Dota are poor predictors of skill and gameplay fairness. player_ratings_csv2 is created that only contains players that have played more than 5 games.

# Exploratory Data Analysis

## Hero Stats
players_csv has detailed information about the player, the hero they chose and their in-game performance. This information is grouped by hero class, which are STR/INT/AGI. Further, all stats are normalized such that a particular stat of STR hero plus AGI hero plus INT hero equals zero. This operation allows us to view all stats on a single heatmap. The code and the heatmap is shown below
```{r 4}
Scaled_Stats_by_hero_type_m <- read.csv("Data/Scaled_Stats_by_hero_type_m.csv")

ggplot(Scaled_Stats_by_hero_type_m, aes(x=Var1,y=Var2,fill=value)) + geom_tile() + labs(x="Type of Hero",y="Stats") + scale_fill_gradient(low="white",high="red")

```
## Percentage of Wins
While total_wins is available for each account_id, simply looking at total_wins is inadequate. More accurate is to look at percentage_wins. This is possible since we know both total_wins and total_matches.

Using this metric, we plot a histogram of percentage of wins. Highest occurence of percentage_wins is 0.5, showing that maximum players win half their games.

```{r 5}

players_ratings_csv2 <- read.csv("Data/players_ratings_csv2.csv")

# Histogram line plot of percentage_wins statistic by player account_id. Most players win half the games they play.

ggplot(players_ratings_csv2,aes(percentage_wins)) +geom_histogram(aes(y=..density..)) + geom_density(aes(y=..density..))

```

## Correlation between trueskill_mu and percentage_wins
trueskill_mu is a fan defined measure of player skill. To check its accuracy, we correlate it with percentage_wins. Graph shows that higher skill level implies higher win percentage. Since player skill is hard to measure, a standard deviation measure of player ability is included. The different colors of the below dots gives the different standard deviations. 

```{r 6}


# Scatter plot of trueskill_mu and percentage_wins in players_ratings_csv2. trueskill_sigma is assigned to color attribute. Both trueskill attributes are calculated by Dota fans and not by Valve corporation. While trueskill_mu is indicator of player`s ability, with higher value implying better player, trueskill_sigma is the uncertainty in the trueskill_mu measure. As expected, skill and win percentage are correlated. 

ggplot(players_ratings_csv2,aes(x=trueskill_mu,y=percentage_wins,col=trueskill_sigma)) +geom_point() + geom_jitter(shape=1)
```

## Boxplot of item types and hero levels at end of game.  Since a hero can have 6 items (item_0 to item_5), there are 6 different box plots

Below plot, drawn between item_0 and hero level, shows the Dam (Damage) item type to have highest level median, followed by Disable. Int item types have the lowest median level.
```{r 7,echo=FALSE}
players_csv2 <- read.csv("Data/players_csv2.csv")
function_boxplot_level_itemclass <- function(a){ggplot(players_csv2,aes(x=a,y=level)) + geom_boxplot() + theme(axis.text.x=element_text(angle=-90)) + labs(x="Item types bought by Hero",y="Hero level at game end")}

function_boxplot_level_itemclass(players_csv2$item_0)

```

Similar plots were made for item_1 to item_5 versus hero level. All plots had very similar final outputs.

Based on this, it can be inferred that Damage and Disable class items lead to the highest hero median level while Int item types lead to the lowest hero median level. The opposite of this statement could also be true. It is possible that Damage and Disable items are late game items that can only be bought by heroes that have substantially levelled up. The next few sections will try to infer if higher hero levels are caused by specific items or if heroes are able to buy these specific items only after reaching those higher levels.

## Lineplot of the percentage of items acquired by each hero type for each item slot location in hero inventory

Below line plot shows percentage of item classes acquired by each hero type. For instance, more than 35% of AGI heroes acquire 2 Class items in the item_0 inventory slot. The trend for different item slots is similar, as seen from the shape of the different line graphs. 

```{r 8}
item_and_hero_m <- read.csv("Data/item_and_hero_m.csv")

ggplot(item_and_hero_m,aes(x=new,y=value,colour=variable,group=1)) + geom_point() + geom_line(aes(group=variable)) + theme(axis.text.x=element_text(angle=-90)) + labs(x="Item class of the respective hero type",y="Percentage of observations") 

```

## Does high median hero level lead to purchase of damage/disable items or does purchase of damage/disable items lead to high median hero level?

The above line graph was obtained after excluding observations that constituted less than 5% of total observations per hero. This filter excluded observations in which heroes solely chose damage or disable items. If the strategy of buying solely damage or disable  items were successfull, it is likely that more players would have chosen to buy standalone damage or disable items. This graph shows that only very few players chose to buy these items. So, it can be concluded that high median level for heroes that bought damage and disable items is due to the reasoning that damage and disable items are only available at these higher levels and not the other way.

## Identify heroes that win most games

```{r 9}
players_csv3_winning_heroes_radiant <- read.csv("Data/players_csv3_winning_heroes_radiant.csv")

players_csv3_winning_heroes_dire <- read.csv("Data/players_csv3_winning_heroes_dire.csv")

ggplot(na.omit(players_csv3_winning_heroes_radiant),aes(x=winning_heroes_radiant)) + geom_histogram(stat="count")

ggplot(na.omit(players_csv3_winning_heroes_dire),aes(x=winning_heroes_dire)) + geom_histogram(stat="count")
```
INT heroes have won maximum number of games followed by STR heroes. This trend is the same for both radiant and dire teams.

# Identify heroes that have highest probability of winning

```{r 10}
Prob_Hero_Winning <- read.csv("Data/Prob_Hero_Winning.csv")

barplot(Prob_Hero_Winning$x,main="Probability of winning for each hero type",names.arg = c("INT","AGI","STR"))

```
STR heroes have highest probability of winning, followed by AGI and then INT. 

## Team hero combinations and winnability

```{r 11}
Team_Hero_Winning <- read.csv("Data/Team_Hero_Winning.csv")

barplot(Team_Hero_Winning$x,main="Total team wins where team had >=3 heroes of same type",names.arg = c("STR","AGI","INT"))

```
Teams that have combination of >=3 INT heroes win more games, followed by teams that have combination of >= 3 STR heroes.